<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/B í…ŒìŠ¤íŠ¸ ê³„ì‚°ê¸° v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 16px 16px 0 0;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 8px;
        }

        .content {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111827;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-unit input {
            flex: 1;
        }

        .unit {
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
            min-width: 30px;
        }

        .help-text {
            font-size: 13px;
            color: #6b7280;
            margin-top: 6px;
        }

        .info-text {
            font-size: 13px;
            color: #6b7280;
            margin-top: 6px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            display: none;
        }

        .info-text.show {
            display: block;
        }

        .mde-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .mde-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            transition: all 0.2s;
        }

        .mde-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .mde-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .example-text {
            font-size: 13px;
            color: #6b7280;
            margin-top: 6px;
        }

        .allocation-description {
            margin-top: 8px;
            padding: 8px 12px;
            background: #f9fafb;
            border-left: 3px solid #667eea;
            font-size: 13px;
            color: #374151;
            border-radius: 4px;
        }

        .custom-allocation {
            margin-top: 12px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            display: none;
        }

        .custom-allocation.show {
            display: block;
        }

        .custom-inputs {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 8px;
        }

        .custom-inputs input {
            width: 80px;
        }

        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 8px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .result-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-main {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 14px;
            color: #6b7280;
        }

        .result-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .result-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .result-card-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .result-card-value {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }

        .slot-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
        }

        .slot-section h3 {
            color: #0369a1;
        }

        .slot-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .slot-range-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
        }

        .slot-range-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .slot-range-value {
            font-size: 18px;
            font-weight: 600;
            color: #0369a1;
        }

        .estimation-info {
            margin-top: 16px;
            padding: 16px;
            background: #fffbeb;
            border-left: 3px solid #f59e0b;
            border-radius: 4px;
            font-size: 13px;
            color: #92400e;
        }

        .estimation-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #78350f;
        }

        .estimation-details {
            margin-top: 8px;
            font-size: 12px;
            color: #92400e;
            line-height: 1.6;
        }

        .warning-box {
            margin-top: 12px;
            padding: 12px;
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            border-radius: 4px;
            font-size: 13px;
            color: #991b1b;
        }

        .success-box {
            margin-top: 12px;
            padding: 12px;
            background: #f0fdf4;
            border-left: 3px solid #10b981;
            border-radius: 4px;
            font-size: 13px;
            color: #065f46;
        }

        .collapsible {
            margin-top: 12px;
        }

        .collapsible-header {
            padding: 10px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .collapsible-header:hover {
            background: #e5e7eb;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.show {
            max-height: 500px;
        }

        .collapsible-body {
            padding: 12px;
            font-size: 13px;
            color: #4b5563;
            line-height: 1.6;
        }

        .sql-code {
            background: #1f2937;
            color: #f3f4f6;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 8px;
            overflow-x: auto;
            white-space: pre;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 13px;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>A/B í…ŒìŠ¤íŠ¸ ê³„ì‚°ê¸°</h1>
            <p>ì „í™˜ìœ¨ ê°œì„ ì„ ìœ„í•œ ìƒ˜í”Œ ìˆ˜ ê³„ì‚°</p>
            <span class="version-badge">v2.0 - ìŠ¬ë¡¯ ìë™ ê³„ì‚°</span>
        </div>

        <div class="content">
            <form id="calculator-form">
                <!-- 1. í˜„ì¬ ì§€í‘œ -->
                <div class="form-group">
                    <label for="prop-baseline">1. í˜„ì¬ ì§€í‘œëŠ” ì–¼ë§ˆì¸ê°€ìš”?</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="input-with-unit" style="flex: 1;">
                            <input type="number" id="prop-baseline" placeholder="ì˜ˆ: 3" step="0.01" min="0" max="100" required>
                            <span class="unit">%</span>
                        </div>
                    </div>
                    <div class="help-text">í˜„ì¬ ì „í™˜ìœ¨, í´ë¦­ë¥  ë“±ì˜ ì§€í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <!-- 2. ëª©í‘œ ê°œì„  -->
                <div class="form-group">
                    <label for="prop-mde">2. ì–¼ë§ˆë‚˜ ê°œì„ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</label>
                    <div class="mde-buttons">
                        <button type="button" class="mde-btn" data-value="5">+5%</button>
                        <button type="button" class="mde-btn" data-value="10">+10%</button>
                        <button type="button" class="mde-btn" data-value="20">+20%</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="input-with-unit" style="flex: 1;">
                            <input type="number" id="prop-mde" placeholder="ì˜ˆ: 10" step="0.1" min="0" required>
                            <span class="unit">%</span>
                        </div>
                    </div>
                    <div class="example-text" id="mde-example">ì˜ˆ: 3% â†’ 3.30% (10% ìƒëŒ€ ê°œì„ )</div>
                </div>

                <!-- 3. í•˜ë£¨ ë°©ë¬¸ìˆ˜ -->
                <div class="form-group">
                    <label for="prop-daily-visitors">3. í•˜ë£¨ì— ëª‡ ëª…ì´ ë°©ë¬¸í•˜ëŠ” ì§€ë©´ì¸ê°€ìš”?</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="input-with-unit" style="flex: 1;">
                            <input type="number" id="prop-daily-visitors" placeholder="ì˜ˆ: 100000" step="1" min="1" required>
                            <span class="unit">ëª…</span>
                        </div>
                    </div>
                    <div class="help-text">ì‹¤í—˜ ëŒ€ìƒ ì§€ë©´ì˜ í•˜ë£¨ í‰ê·  ë°©ë¬¸ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
                    <div class="info-text" id="visitors-feedback"></div>
                </div>

                <!-- 4. í…ŒìŠ¤íŠ¸ ê¸°ê°„ -->
                <div class="form-group">
                    <label for="prop-duration">4. í…ŒìŠ¤íŠ¸ ê¸°ê°„</label>
                    <div class="input-with-unit">
                        <input type="number" id="prop-duration" placeholder="ì˜ˆ: 14" value="14" step="1" min="1" required>
                        <span class="unit">ì¼</span>
                        <span style="margin-left: 8px; color: #f59e0b; font-size: 14px;">â­ ê¶Œì¥</span>
                    </div>
                    <div class="help-text">7ì¼ì€ ìš”ì¼ íš¨ê³¼ë¥¼ ì œê±°í•˜ëŠ” ìµœì†Œ ê¶Œì¥ ê¸°ê°„ì…ë‹ˆë‹¤</div>
                    <div class="info-text" id="duration-feedback"></div>
                </div>

                <!-- 5. ë°°ë¶„ ë¹„ìœ¨ -->
                <div class="form-group">
                    <label for="prop-allocation">5. ì‹¤í—˜êµ° ë°°ë¶„ ë¹„ìœ¨ì€ ì–´ë–»ê²Œ í•˜ì‹œê² ì–´ìš”?</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="prop-allocation" style="flex: 1;">
                            <option value="50:50" selected>50:50</option>
                            <option value="60:40">60:40</option>
                            <option value="70:30">70:30</option>
                            <option value="80:20">80:20</option>
                            <option value="custom">ì§ì ‘ ì…ë ¥</option>
                        </select>
                        <span style="color: #f59e0b; font-size: 14px; font-weight: 600; white-space: nowrap;">â­ ê¶Œì¥</span>
                    </div>
                    <div class="allocation-description" id="allocation-description">
                        â­ ê°€ì¥ íš¨ìœ¨ì ì¸ ë°°ë¶„ ë¹„ìœ¨ì…ë‹ˆë‹¤ (ê¸°ë³¸ê°’)
                    </div>
                    <div class="custom-allocation" id="custom-allocation">
                        <label style="font-size: 13px; margin-bottom: 8px;">ë°°ë¶„ ë¹„ìœ¨ ì§ì ‘ ì…ë ¥</label>
                        <div class="custom-inputs">
                            <div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">ëŒ€ì¡°êµ°</div>
                                <input type="number" id="custom-control" placeholder="50" min="1" max="99">
                            </div>
                            <div style="font-size: 20px; color: #9ca3af;">:</div>
                            <div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">ì‹¤í—˜êµ°</div>
                                <input type="number" id="custom-treatment" placeholder="50" min="1" max="99">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê³ ê¸‰ ì„¤ì • -->
                <div class="collapsible" style="margin-top: 24px; margin-bottom: 16px;">
                    <div class="collapsible-header" id="advanced-toggle">
                        âš™ï¸ ê³ ê¸‰ ì„¤ì • (ì„ íƒì‚¬í•­)
                    </div>
                    <div class="collapsible-content" id="advanced-content">
                        <div class="collapsible-body">
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label for="alpha-level" style="font-size: 14px;">ìœ ì˜ìˆ˜ì¤€ (Alpha)</label>
                                <select id="alpha-level" style="font-size: 14px;">
                                    <option value="0.05" selected>0.05 (5%) - ê¶Œì¥</option>
                                    <option value="0.01">0.01 (1%) - ì—„ê²©</option>
                                    <option value="0.10">0.10 (10%) - ì™„í™”</option>
                                </select>
                                <div class="help-text">1ì¢… ì˜¤ë¥˜ í™•ë¥  (ì˜ëª»ëœ ê¸ì •)</div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label for="power-level" style="font-size: 14px;">ê²€ì •ë ¥ (Power)</label>
                                <select id="power-level" style="font-size: 14px;">
                                    <option value="0.80" selected>0.80 (80%) - ê¶Œì¥</option>
                                    <option value="0.90">0.90 (90%) - ë†’ìŒ</option>
                                    <option value="0.70">0.70 (70%) - ë‚®ìŒ</option>
                                </select>
                                <div class="help-text">2ì¢… ì˜¤ë¥˜ë¥¼ í”¼í•  í™•ë¥ </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="custom-coefficient" style="font-size: 14px;">ì¶”ì • ê³„ìˆ˜ ì§ì ‘ ì…ë ¥</label>
                                <div class="input-with-unit">
                                    <input type="number" id="custom-coefficient" placeholder="ìë™ (ê¸°ê°„ë³„)" step="0.01" min="0.1" max="1.0" style="font-size: 14px;">
                                    <span class="unit" style="font-size: 14px;">ìë™</span>
                                </div>
                                <div class="help-text">ë¹„ì›Œë‘ë©´ ê¸°ê°„ë³„ ìë™ ê³„ì‚° (7ì¼=0.60, 14ì¼=0.50)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="calculate-btn">ê³„ì‚°í•˜ê¸°</button>
            </form>

            <!-- ê²°ê³¼ ì˜ì—­ -->
            <div class="results" id="results">
                <!-- ìƒ˜í”Œ ê²°ê³¼ -->
                <div class="result-section">
                    <h3>ğŸ“Š í•„ìš” ìƒ˜í”Œ</h3>
                    <div class="result-cards">
                        <div class="result-card">
                            <div class="result-card-label">ëŒ€ì¡°êµ° (Aì•ˆ)</div>
                            <div class="result-card-value" id="result-control"></div>
                        </div>
                        <div class="result-card">
                            <div class="result-card-label">ì‹¤í—˜êµ° (Bì•ˆ)</div>
                            <div class="result-card-value" id="result-treatment"></div>
                        </div>
                        <div class="result-card">
                            <div class="result-card-label">ì´ í•„ìš” ìƒ˜í”Œ</div>
                            <div class="result-card-value" id="result-total"></div>
                        </div>
                        <div class="result-card">
                            <div class="result-card-label">ë°°ë¶„ íš¨ìœ¨ì„±</div>
                            <div class="result-card-value" id="result-efficiency"></div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;" id="result-efficiency-note"></div>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¬ë¡¯ í• ë‹¹ -->
                <div class="result-section slot-section">
                    <h3>ğŸ¯ ìŠ¬ë¡¯ í• ë‹¹</h3>
                    <div class="result-main" id="result-slots-main"></div>
                    <div class="result-label">í•„ìš” ìŠ¬ë¡¯</div>
                    
                    <div class="slot-range">
                        <div class="slot-range-item">
                            <div class="slot-range-label">ëŒ€ì¡°êµ° ìŠ¬ë¡¯</div>
                            <div class="slot-range-value" id="result-slots-control"></div>
                        </div>
                        <div class="slot-range-item">
                            <div class="slot-range-label">ì‹¤í—˜êµ° ìŠ¬ë¡¯</div>
                            <div class="slot-range-value" id="result-slots-treatment"></div>
                        </div>
                    </div>

                    <div id="slot-warning"></div>
                </div>

                <!-- ê³„ì‚° ê¸°ì¤€ ì •ë³´ -->
                <div class="estimation-info">
                    <h4>ğŸ’¡ ê³„ì‚° ê¸°ì¤€</h4>
                    <div style="margin-top: 8px; line-height: 1.6;">
                        <strong>ì…ë ¥ ì •ë³´:</strong><br>
                        â€¢ í•˜ë£¨ ë°©ë¬¸: <span id="info-daily-visitors"></span>ëª…<br>
                        â€¢ ì‹¤í—˜ ê¸°ê°„: <span id="info-duration"></span>ì¼
                    </div>
                    <div class="estimation-details">
                        <strong>ìë™ ì¶”ì •:</strong><br>
                        â€¢ <span id="info-duration-text"></span>ì¼ ê³ ìœ  ìœ ì €: ~<span id="info-unique-users"></span>ëª…<br>
                        &nbsp;&nbsp;(í•˜ë£¨ ë°©ë¬¸ Ã— <span id="info-duration-calc"></span>ì¼ Ã— <span id="info-coefficient"></span>)<br>
                        â€¢ ìŠ¬ë¡¯ 1ê°œë‹¹: ì•½ <span id="info-users-per-slot"></span>ëª…
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header" id="detail-toggle">
                            â„¹ï¸ ë” ì •í™•í•œ ê³„ì‚°ì´ í•„ìš”í•˜ì‹ ê°€ìš”?
                        </div>
                        <div class="collapsible-content" id="detail-content">
                            <div class="collapsible-body">
                                <p style="margin-bottom: 8px;">âš ï¸ <strong>ì´ ê°’ì€ ì¶”ì • ê³„ìˆ˜ <span id="detail-coefficient"></span> ê¸°ì¤€ ì¶”ì •ì¹˜ì…ë‹ˆë‹¤.</strong></p>
                                <p style="margin-bottom: 12px;">ë” ì •í™•í•œ ê³„ì‚°ì„ ì›í•˜ì‹œë©´ ê³¼ê±° <span id="detail-duration"></span>ì¼ ê³ ìœ  ìœ ì €ë¥¼ ì§ì ‘ ì¡°íšŒí•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.</p>
                                
                                <strong>SQL ì¿¼ë¦¬ ì˜ˆì‹œ:</strong>
                                <p style="margin: 8px 0 4px 0; font-size: 13px;"><strong>WW Applog</strong></p>
                                <div class="sql-code" id="sql-query-ww"></div>
                                <p style="margin: 12px 0 4px 0; font-size: 13px;"><strong>Perseus Log</strong></p>
                                <div class="sql-code" id="sql-query-perseus"></div>
                                
                                <p style="margin-top: 12px; font-size: 12px; color: #6b7280;">
                                    ì‹¤ì œ ê³ ìœ  ìœ ì € ìˆ˜ë¡œ ë‹¤ì‹œ ê³„ì‚°í•˜ë ¤ë©´ ìœ„ ì¿¼ë¦¬ë¡œ ì¡°íšŒí•œ ê°’ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="footer">
            Built by <a href="mailto:zonetwo.project@gmail.com">zonetwo.project</a> | 
            <a href="https://github.com/jabezpark/ab-test-calculator" target="_blank">GitHub</a>
        </div>
    </div>

    <script>
        // ============================================
        // ì„¤ì •
        // ============================================
        const CONFIG = {
            DEDUPLICATION_COEFFICIENT: {
                1: 1.00,
                3: 0.75,
                7: 0.60,
                14: 0.50,
                21: 0.45,
                30: 0.40,
                60: 0.30
            },
            TOTAL_SLOTS: 10000,
            ALLOCATION_DESCRIPTIONS: {
                '50:50': 'â­ ê°€ì¥ íš¨ìœ¨ì ì¸ ë°°ë¶„ ë¹„ìœ¨ì…ë‹ˆë‹¤ (ê¸°ë³¸ê°’)',
                '60:40': 'ê· í˜•ì¡íŒ ë°°ë¶„ ë¹„ìœ¨ì…ë‹ˆë‹¤',
                '70:30': 'ì‹¤í—˜êµ° ë¹„ì¤‘ì„ ë‚®ì¶˜ ë°°ë¶„ì…ë‹ˆë‹¤',
                '80:20': 'ğŸ›¡ï¸ ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” ë°°ë¶„ ë¹„ìœ¨ì…ë‹ˆë‹¤',
                'custom': 'ì§ì ‘ ì§€ì •í•œ ë°°ë¶„ ë¹„ìœ¨ì…ë‹ˆë‹¤'
            }
        };

        // ============================================
        // í—¬í¼ í•¨ìˆ˜
        // ============================================
        function getCoefficient(duration) {
            if (CONFIG.DEDUPLICATION_COEFFICIENT[duration]) {
                return CONFIG.DEDUPLICATION_COEFFICIENT[duration];
            }
            
            const keys = Object.keys(CONFIG.DEDUPLICATION_COEFFICIENT)
                .map(Number)
                .sort((a, b) => a - b);
            
            for (let i = 0; i < keys.length - 1; i++) {
                const lower = keys[i];
                const upper = keys[i + 1];
                
                if (duration >= lower && duration <= upper) {
                    const ratio = (duration - lower) / (upper - lower);
                    const lowerCoef = CONFIG.DEDUPLICATION_COEFFICIENT[lower];
                    const upperCoef = CONFIG.DEDUPLICATION_COEFFICIENT[upper];
                    return lowerCoef - (lowerCoef - upperCoef) * ratio;
                }
            }
            
            if (duration < keys[0]) return CONFIG.DEDUPLICATION_COEFFICIENT[keys[0]];
            return CONFIG.DEDUPLICATION_COEFFICIENT[keys[keys.length - 1]];
        }

        function formatNumber(num) {
            return num.toLocaleString('ko-KR');
        }

        function getDateRange(days) {
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() - 1);
            
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - days + 1);
            
            return {
                start: startDate.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        }

        // ============================================
        // MDE ë²„íŠ¼ ì´ë²¤íŠ¸
        // ============================================
        document.querySelectorAll('.mde-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const value = this.dataset.value;
                document.getElementById('prop-mde').value = value;
                
                document.querySelectorAll('.mde-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                updateMdeExample();
            });
        });

        // ============================================
        // MDE ì˜ˆì‹œ ì—…ë°ì´íŠ¸
        // ============================================
        function updateMdeExample() {
            const baseline = parseFloat(document.getElementById('prop-baseline').value) || 3;
            const mde = parseFloat(document.getElementById('prop-mde').value) || 10;
            
            const newValue = baseline * (1 + mde / 100);
            const exampleText = `ì˜ˆ: ${baseline}% â†’ ${newValue.toFixed(2)}% (${mde}% ìƒëŒ€ ê°œì„ )`;
            document.getElementById('mde-example').textContent = exampleText;
            
            // MDE ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.mde-btn').forEach(btn => {
                if (btn.dataset.value == mde) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        document.getElementById('prop-baseline').addEventListener('input', updateMdeExample);
        document.getElementById('prop-mde').addEventListener('input', updateMdeExample);

        // ============================================
        // ë°°ë¶„ ë¹„ìœ¨ ë³€ê²½
        // ============================================
        document.getElementById('prop-allocation').addEventListener('change', function() {
            const value = this.value;
            const description = document.getElementById('allocation-description');
            const customDiv = document.getElementById('custom-allocation');
            
            description.textContent = CONFIG.ALLOCATION_DESCRIPTIONS[value];
            
            if (value === 'custom') {
                customDiv.classList.add('show');
            } else {
                customDiv.classList.remove('show');
            }
        });

        // ============================================
        // ê¸°ê°„ ê°€ì´ë“œ
        // ============================================
        document.getElementById('prop-duration').addEventListener('input', function() {
            const days = parseInt(this.value);
            const feedback = document.getElementById('duration-feedback');
            
            if (!days || days < 1) {
                feedback.textContent = 'âŒ 1ì¼ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”';
                feedback.style.color = '#ef4444';
                feedback.classList.add('show');
                return;
            }
            
            feedback.classList.add('show');
            
            if (days < 7) {
                feedback.textContent = `ğŸ’¡ ${days}ì¼ì€ 7ì¼ ë¯¸ë§Œìœ¼ë¡œ ìš”ì¼ íš¨ê³¼ê°€ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤`;
                feedback.style.color = '#6b7280';
            } else if (days === 7) {
                feedback.textContent = 'âœ… ìš”ì¼ íš¨ê³¼ë¥¼ ì œê±°í•˜ëŠ” ìµœì†Œ ê¶Œì¥ ê¸°ê°„ì…ë‹ˆë‹¤';
                feedback.style.color = '#10b981';
            } else if (days >= 14) {
                feedback.textContent = `âœ… ${days}ì¼ì€ ìš”ì¼ íš¨ê³¼ë¥¼ ì™„ì „íˆ ì œê±°í•˜ëŠ” ì¶©ë¶„í•œ ê¸°ê°„ì…ë‹ˆë‹¤`;
                feedback.style.color = '#10b981';
            } else {
                feedback.textContent = `âœ… ${days}ì¼ì€ ì ì ˆí•œ ê¸°ê°„ì…ë‹ˆë‹¤`;
                feedback.style.color = '#10b981';
            }
        });

        // ============================================
        // ë°©ë¬¸ìˆ˜ ê°€ì´ë“œ
        // ============================================
        document.getElementById('prop-daily-visitors').addEventListener('input', function() {
            const visitors = parseFloat(this.value);
            const feedback = document.getElementById('visitors-feedback');
            
            if (!visitors || visitors < 1) {
                feedback.textContent = 'âŒ 1ëª… ì´ìƒ ì…ë ¥í•˜ì„¸ìš”';
                feedback.style.color = '#ef4444';
                feedback.classList.add('show');
                return;
            }
            
            if (visitors < 1000) {
                feedback.textContent = 'ğŸ’¡ ë°©ë¬¸ìˆ˜ê°€ ì ì–´ ì‹¤í—˜ ê¸°ê°„ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                feedback.style.color = '#6b7280';
                feedback.classList.add('show');
            } else {
                feedback.classList.remove('show');
            }
        });

        // ============================================
        // ê³„ì‚° í•¨ìˆ˜
        // ============================================
        function calculateABTest(formData) {
            const {baseline, mde, dailyVisitors, duration, allocation} = formData;
            
            // 1. í†µê³„ íŒŒë¼ë¯¸í„° (ê³ ê¸‰ ì„¤ì •ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
            const alpha = parseFloat(document.getElementById('alpha-level').value);
            const power = parseFloat(document.getElementById('power-level').value);
            
            // Z-score ê³„ì‚°
            const z_alpha = alpha === 0.05 ? 1.96 : (alpha === 0.01 ? 2.576 : 1.645);
            const z_beta = power === 0.80 ? 0.84 : (power === 0.90 ? 1.282 : 0.524);
            
            // 2. ë°°ë¶„ ë¹„ìœ¨ ê³„ì‚°
            let controlRatio, treatmentRatio;
            if (allocation === 'custom') {
                const control = parseInt(document.getElementById('custom-control').value) || 50;
                const treatment = parseInt(document.getElementById('custom-treatment').value) || 50;
                const total = control + treatment;
                controlRatio = control / total;
                treatmentRatio = treatment / total;
            } else {
                const [c, t] = allocation.split(':').map(Number);
                const total = c + t;
                controlRatio = c / total;
                treatmentRatio = t / total;
            }
            
            const kappa = treatmentRatio / controlRatio;
            
            // 3. ìƒ˜í”Œ í¬ê¸° ê³„ì‚°
            const p1 = baseline / 100;
            const p2 = p1 * (1 + mde / 100);
            const p_pooled = (p1 + kappa * p2) / (1 + kappa);
            
            const n1 = Math.pow(z_alpha + z_beta, 2) * 
                       (p1 * (1 - p1) + p2 * (1 - p2) / kappa) /
                       Math.pow(p2 - p1, 2);
            
            const n2 = n1 * kappa;
            const nTotal = Math.ceil(n1 + n2);
            
            // 4. ê³ ìœ  ìœ ì € ì¶”ì • (ì»¤ìŠ¤í…€ ê³„ìˆ˜ ìš°ì„ )
            const customCoef = parseFloat(document.getElementById('custom-coefficient').value);
            const coefficient = customCoef || getCoefficient(duration);
            const estimatedUniqueUsers = Math.round(dailyVisitors * duration * coefficient);
            
            // 5. ìŠ¬ë¡¯ ê³„ì‚°
            const usersPerSlot = estimatedUniqueUsers / CONFIG.TOTAL_SLOTS;
            const requiredSlots = Math.ceil(nTotal / usersPerSlot);
            const slotsPercentage = (requiredSlots / CONFIG.TOTAL_SLOTS * 100).toFixed(2);
            
            // 6. ìŠ¬ë¡¯ ë²”ìœ„
            const controlSlots = Math.ceil(requiredSlots * controlRatio);
            const treatmentSlots = requiredSlots - controlSlots;
            
            // 7. íš¨ìœ¨ì„± ê³„ì‚°
            const treatmentPortion = treatmentRatio / (controlRatio + treatmentRatio);
            const relativeEfficiency = 4 * treatmentPortion * (1 - treatmentPortion);
            const efficiency = (relativeEfficiency * 100).toFixed(0);
            
            // 50:50 ëŒ€ë¹„ ì¶”ê°€ ìƒ˜í”Œ ë¹„ìœ¨
            const sampleMultiplier = (1 / relativeEfficiency).toFixed(2);
            const additionalPercent = ((1 / relativeEfficiency - 1) * 100).toFixed(0);
            
            return {
                samples: {
                    control: Math.ceil(n1),
                    treatment: Math.ceil(n2),
                    total: nTotal
                },
                slots: {
                    total: requiredSlots,
                    percentage: slotsPercentage,
                    control: {
                        start: 1,
                        end: controlSlots
                    },
                    treatment: {
                        start: controlSlots + 1,
                        end: requiredSlots
                    }
                },
                estimation: {
                    dailyVisitors: dailyVisitors,
                    duration: duration,
                    coefficient: coefficient.toFixed(2),
                    uniqueUsers: estimatedUniqueUsers,
                    usersPerSlot: Math.round(usersPerSlot)
                },
                efficiency: {
                    percentage: efficiency,
                    multiplier: sampleMultiplier,
                    additionalPercent: additionalPercent,
                    isOptimal: relativeEfficiency >= 0.99
                }
            };
        }

        // ============================================
        // ê²°ê³¼ í‘œì‹œ
        // ============================================
        function displayResults(result) {
            // ìƒ˜í”Œ
            document.getElementById('result-control').textContent = formatNumber(result.samples.control) + 'ëª…';
            document.getElementById('result-treatment').textContent = formatNumber(result.samples.treatment) + 'ëª…';
            document.getElementById('result-total').textContent = formatNumber(result.samples.total) + 'ëª…';
            
            // íš¨ìœ¨ì„±
            document.getElementById('result-efficiency').textContent = result.efficiency.percentage + '%';
            
            const efficiencyNote = document.getElementById('result-efficiency-note');
            if (result.efficiency.isOptimal) {
                efficiencyNote.textContent = 'ê°€ì¥ íš¨ìœ¨ì ì¸ ë°°ë¶„ì…ë‹ˆë‹¤';
                efficiencyNote.style.color = '#10b981';
            } else if (result.efficiency.additionalPercent == 0) {
                efficiencyNote.textContent = 'ìµœì  ë°°ë¶„ê³¼ ë™ì¼í•©ë‹ˆë‹¤';
                efficiencyNote.style.color = '#10b981';
            } else {
                efficiencyNote.textContent = `50:50 ëŒ€ë¹„ ${result.efficiency.multiplier}ë°° ìƒ˜í”Œ í•„ìš” (+${result.efficiency.additionalPercent}%)`;
                efficiencyNote.style.color = '#f59e0b';
            }
            
            // ìŠ¬ë¡¯
            document.getElementById('result-slots-main').textContent = 
                `${formatNumber(result.slots.total)}ê°œ (${result.slots.percentage}%)`;
            document.getElementById('result-slots-control').textContent = 
                `${result.slots.control.start} ~ ${result.slots.control.end}`;
            document.getElementById('result-slots-treatment').textContent = 
                `${result.slots.treatment.start} ~ ${result.slots.treatment.end}`;
            
            // ìŠ¬ë¡¯ ê²½ê³ 
            const warningDiv = document.getElementById('slot-warning');
            const percentage = parseFloat(result.slots.percentage);
            
            if (result.slots.total > CONFIG.TOTAL_SLOTS) {
                warningDiv.innerHTML = `
                    <div class="warning-box">
                        âŒ í•„ìš” ìŠ¬ë¡¯(${formatNumber(result.slots.total)}ê°œ)ì´ ì „ì²´ ìŠ¬ë¡¯(10,000ê°œ)ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.<br>
                        <strong>í•´ê²° ë°©ë²•:</strong><br>
                        â€¢ ì‹¤í—˜ ê¸°ê°„ì„ ëŠ˜ë¦¬ê¸°<br>
                        â€¢ ëª©í‘œ ê°œì„ í­ì„ ì¤„ì´ê¸°
                    </div>
                `;
            } else if (percentage > 50) {
                warningDiv.innerHTML = `
                    <div class="warning-box">
                        âš ï¸ ìŠ¬ë¡¯ ì‚¬ìš©ë¥ ì´ ${percentage}%ë¡œ ë†’ìŠµë‹ˆë‹¤.<br>
                        ë‹¤ë¥¸ ì‹¤í—˜ê³¼ ë³‘í–‰ ì‹¤í–‰ ì‹œ ì£¼ì˜í•˜ì„¸ìš”.
                    </div>
                `;
            } else if (percentage > 30) {
                warningDiv.innerHTML = `
                    <div class="success-box">
                        ğŸ’¡ ìŠ¬ë¡¯ ì‚¬ìš©ë¥ ì´ ${percentage}%ì…ë‹ˆë‹¤. ì—¬ìœ ìˆëŠ” í¸ì…ë‹ˆë‹¤.
                    </div>
                `;
            } else {
                warningDiv.innerHTML = `
                    <div class="success-box">
                        âœ… ìŠ¬ë¡¯ ì‚¬ìš©ë¥ ì´ ${percentage}%ë¡œ íš¨ìœ¨ì ì…ë‹ˆë‹¤.
                    </div>
                `;
            }
            
            // ê³„ì‚° ê¸°ì¤€ ì •ë³´
            document.getElementById('info-daily-visitors').textContent = formatNumber(result.estimation.dailyVisitors);
            document.getElementById('info-duration').textContent = result.estimation.duration;
            document.getElementById('info-duration-text').textContent = result.estimation.duration;
            document.getElementById('info-duration-calc').textContent = result.estimation.duration;
            document.getElementById('info-unique-users').textContent = formatNumber(result.estimation.uniqueUsers);
            document.getElementById('info-coefficient').textContent = result.estimation.coefficient;
            document.getElementById('info-users-per-slot').textContent = formatNumber(result.estimation.usersPerSlot);
            
            // ìƒì„¸ ì •ë³´
            document.getElementById('detail-coefficient').textContent = result.estimation.coefficient;
            document.getElementById('detail-duration').textContent = result.estimation.duration;
            
            // SQL ì¿¼ë¦¬ (ë‚ ì§œ ìƒí•œì€ exclusiveì´ë¯€ë¡œ end ë‹¤ìŒ ë‚  ì‚¬ìš©)
            const dateRange = getDateRange(result.estimation.duration);
            const endExclusive = (() => {
                const d = new Date(dateRange.end + 'T00:00:00');
                d.setDate(d.getDate() + 1);
                return d.toISOString().split('T')[0];
            })();
            const sqlQueryWw = `SELECT COUNT(DISTINCT dvc_id) AS unique_users
FROM dslog.log_baemin_app_ib
WHERE screen_name = 'ì‹¤í—˜_ì§€ë©´ëª…'  -- ìˆ˜ì • í•„ìš”: ì‹¤ì œ ì‹¤í—˜ ì§€ë©´ëª…ìœ¼ë¡œ ë³€ê²½
  AND log_ts >= TIMESTAMP '${dateRange.start}'
  AND log_ts < TIMESTAMP '${endExclusive}'
  -- AND env = 'RELEASE'  -- í•„ìš” ì‹œ ì£¼ì„ í•´ì œ`;
            const sqlQueryPerseus = `SELECT COUNT(DISTINCT dvc_id) AS unique_users
FROM raw_log.applog_perseus_bmapp_client
WHERE screen_nm = 'ì‹¤í—˜_ì§€ë©´ëª…'  -- ìˆ˜ì • í•„ìš”: ì‹¤ì œ ì‹¤í—˜ ì§€ë©´ëª…ìœ¼ë¡œ ë³€ê²½
  AND log_ts >= TIMESTAMP '${dateRange.start}'
  AND log_ts < TIMESTAMP '${endExclusive}'`;
            document.getElementById('sql-query-ww').textContent = sqlQueryWw;
            document.getElementById('sql-query-perseus').textContent = sqlQueryPerseus;
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('results').classList.add('show');
            
            // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ============================================
        // í¼ ì œì¶œ
        // ============================================
        document.getElementById('calculator-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                baseline: parseFloat(document.getElementById('prop-baseline').value),
                mde: parseFloat(document.getElementById('prop-mde').value),
                dailyVisitors: parseFloat(document.getElementById('prop-daily-visitors').value),
                duration: parseInt(document.getElementById('prop-duration').value),
                allocation: document.getElementById('prop-allocation').value
            };
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!formData.baseline || formData.baseline <= 0 || formData.baseline >= 100) {
                alert('í˜„ì¬ ì§€í‘œë¥¼ 0~100 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (!formData.mde || formData.mde <= 0) {
                alert('ëª©í‘œ ê°œì„ í­ì„ 0ë³´ë‹¤ í° ê°’ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (!formData.dailyVisitors || formData.dailyVisitors < 1) {
                alert('í•˜ë£¨ ë°©ë¬¸ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (!formData.duration || formData.duration < 1) {
                alert('í…ŒìŠ¤íŠ¸ ê¸°ê°„ì„ 1ì¼ ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ê³„ì‚° ë° ê²°ê³¼ í‘œì‹œ
            const result = calculateABTest(formData);
            displayResults(result);
        });

        // ============================================
        // ìƒì„¸ ì •ë³´ í† ê¸€
        // ============================================
        document.getElementById('detail-toggle').addEventListener('click', function() {
            const content = document.getElementById('detail-content');
            content.classList.toggle('show');
        });

        // ============================================
        // ê³ ê¸‰ ì„¤ì • í† ê¸€
        // ============================================
        document.getElementById('advanced-toggle').addEventListener('click', function() {
            const content = document.getElementById('advanced-content');
            content.classList.toggle('show');
        });

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        updateMdeExample();
    </script>
</body>
</html>
